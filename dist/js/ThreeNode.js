!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ThreeNode=t():e.ThreeNode=t()}(window,(function(){return function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="./",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);const o=[Number,String,Date,RegExp,HTMLElement,NodeList,Boolean,Function],r={sunLengthColors:["#3834C9","#308FD5","#1EC1AC","#6AD335","#F9DD31","#FF9419","#EA2121","#BD0B18"],isArray:e=>"[object Array]"===Object.prototype.toString.call(e),isFunction:e=>"[object Function]"===Object.prototype.toString.call(e),isSimpleObj(e){const t=e&&e.constructor===Proxy;return t||"object"!=typeof e&&!t||null==e||!t&&o.some(t=>e instanceof t)},copy(e,t){return Object.keys(t).forEach(n=>{const o=t[n];this.isSimpleObj(o)?e[n]=o:this.isSimpleObj(e[n])?e[n]=this.copy(o instanceof Array?[]:{},o):e[n]=this.copy(e[n],o)}),e},extend(...e){const t=Reflect.apply(Array.prototype.splice,e,[0]);if((t[0]instanceof Boolean||"boolean"==typeof t[0])&&t.splice(0,1)[0]){const e=t.splice(0,1)[0];return t.forEach(t=>this.copy(e,t)),e}return Reflect.apply(Object.assign,Object,t)},toFunction(e){return this.isFunction(e)?e:function(){}},equals:(e,t)=>(t=t||0,Math.abs(e-t)<1e-7),getSunLightColorWithLength(e){const t=e/60,{length:n}=this.sunLengthColors;if(t>=n)return this.sunLengthColors[n-1];for(let e=0;e<n;e++)if(t<e+1)return this.sunLengthColors[e];return this.sunLengthColors[0]},ajaxQuer(e,t){let n=null;n=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObjcet("Microsoft.XMLHTTP"),n.onreadystatechange=function(){if(4==n.readyState){const e=n.status;if(e>=200&&e<300){let e="",o=n.getResponseHeader("Content-type");e=-1!==o.indexOf("xml")&&n.responseXML?n.responseXML:"application/json"===o?JSON.parse(n.responseText):n.responseText,r.toFunction(t(e))}else console.log(e)}},n.open("GET",e,!0),n.send(null)}};var i=r;const a=(new Date).getFullYear(),s=new Date(a+"-03-20"),l=new Date(a+"-06-21"),c=new Date(a+"-09-22"),u=new Date(a+"-12-21");var h={TIME_ZONE:120,PI_ANGLE:180,getSunAngleWithDays(e){let t=-1/0,n=-1/0,o=-1/0,r=-1/0;if(e<=s){const t=new Date(a-1+"-12-21");n=(s-t)/864e5,o=(e-t)/864e5,r=-23.43}else e<=l?(n=(l-s)/864e5,o=(e-s)/864e5,r=0):e<=c?(n=(c-l)/864e5,o=(c-e)/864e5,r=0):e<=u?(n=(u-c)/864e5,o=(u-e)/864e5,r=-23.43):(n=(new Date(a+1+"-03-20")-u)/864e5,o=(e-u)/864e5,r=-23.43);return t=r+o*(23.43/n),t*Math.PI/this.PI_ANGLE},getNoonSunAngle(e){const{lat:t,date:n}=e,o=this.getSunAngleWithDays(n);return Math.PI/2-Math.abs(t*Math.PI/this.PI_ANGLE-o)},getSunRiseDropMsg(e){const{lng:t,lat:n,date:o}=e,r=this.getSunAngleWithDays(o),i=24*(2*Math.PI-2*Math.acos(Math.tan(Math.PI*n/this.PI_ANGLE)*Math.tan(r)))/(2*Math.PI),a=(this.TIME_ZONE-t)/15+12;return{riseTime:a-i/2,dropTime:a+i/2}},getTimeStr(e){const t=Math.floor(e);let n=Math.floor(60*(e-t));return n=n<10?"0"+n:n,t+":"+n}};const d=576,p={width:10,height:10};let m=.5;const g="uniform float u_time;          \n                varying float _y;  \n                varying float _time;\n                void main() { \n                vec3 v_position = mix(vec3(0,0,0),position,u_time); \n                _time =1.0-u_time;           \n                _y = v_position.y;                     \n                vec4 mvPosition = modelViewMatrix * vec4(v_position, 1.0);                 \n                gl_Position = projectionMatrix * mvPosition;\n            }",f="                           \n            uniform vec3 u_color;\n            uniform float u_height; \n            varying float _time;           \n            varying float _y;              \n            void main() {                                \n                gl_FragColor = vec4(u_color, (1.0-_y/u_height)*_time);  \n            }",E={geo:{geo:()=>new THREE.Geometry,buf:()=>new THREE.BufferGeometry,insBuf:()=>new THREE.InstancedBufferGeometry,shape:(e,t)=>new THREE.ShapeBufferGeometry(e,t),extrude:(e,t)=>new THREE.ExtrudeBufferGeometry(e,t),plane:(e,t,n,o)=>new THREE.PlaneBufferGeometry(e,t,n,o),circle:(e,t)=>new THREE.CircleBufferGeometry(e,t),box:(e,t,n)=>new THREE.BoxBufferGeometry(e,t,n),sphere:(e,t,n)=>new THREE.SphereBufferGeometry(e,t,n),torus:(e,t,n,o)=>new THREE.TorusBufferGeometry(e,t,n,o),Icosah:(e,t)=>new THREE.IcosahedronBufferGeometry(e,t),cylinder:(e,t,n,o,r)=>new THREE.CylinderBufferGeometry(e,t,n,o,1,r)},mtl:{point:e=>new THREE.PointsMaterial(e),sprite:e=>new THREE.SpriteMaterial(e),line:e=>new THREE.LineBasicMaterial(e),lineD:e=>new THREE.LineDashedMaterial(e),shader:e=>new THREE.ShaderMaterial(e),basic:e=>new THREE.MeshBasicMaterial(e),phong:e=>new THREE.MeshPhongMaterial(e),lambert:e=>new THREE.MeshLambertMaterial(e),standard:e=>new THREE.MeshStandardMaterial(e)},textureLoader:new THREE.TextureLoader,cubeLoader:new THREE.CubeTextureLoader,obj(e){const t=new THREE.Object3D;return t.name=e,t.userData.describe=e,t},color:e=>new THREE.Color(e),getChangeMatrix(e){const{minX:t,minZ:n,maxX:o,maxZ:r}=e,a=i.equals(o,t)?1:2*p.width/(o-t),s=i.equals(r,n)?1:2*p.height/(r-n),l=Math.min(a,s);return(new THREE.Matrix4).makeScale(l,1,l).multiply((new THREE.Matrix4).makeTranslation(-(o+t)/2,0,-(r+n)/2))},buildPathAnimation(e){e&&new TWEEN.Tween({value:.001}).to({value:1},3e3).easing(TWEEN.Easing.Linear.None).onUpdate((function(){e.scale.y=this.value})).start()},createSpreadObject(e){e=e||{};const{radius:t=3*Math.max(p.width,p.height),color:n="#ffe438",perTime:o=1,height:r=2}=e,i=new THREE.CylinderBufferGeometry(t,t,r,32,1,!0);i.applyMatrix((new THREE.Matrix4).makeTranslation(0,r/2,0));const a=new THREE.ShaderMaterial({uniforms:{u_time:{value:0},u_height:{value:r},u_color:{value:new THREE.Color(n)}},transparent:!0,depthWrite:!1,side:THREE.DoubleSide,blending:THREE.NormalBlending,vertexShader:g,fragmentShader:f}),s=new THREE.Mesh(i,a);return s.userData={_transTime:0,_perTime:o},s},cameraToObject(e,t){const n=t.geometry.boundingSphere.center.clone(),o=e.controls.target.clone();new TWEEN.Tween({x:o.x,y:o.y,z:o.z}).to({x:n.x,y:n.y,z:n.z},1e3).easing(TWEEN.Easing.Sinusoidal.InOut).onUpdate((function(){e.controls.target.set(this.x,this.y,this.z)})).onComplete((function(){})).start()},cameraToPosition(e,t,n){const o=t.clone(),r=e.camera.position.clone(),i=n.clone(),a=e.controls.target.clone();new TWEEN.Tween({targetX:a.x,targetY:a.y,targetZ:a.z,positionX:r.x,positionY:r.y,positionZ:r.z}).to({targetX:i.x,targetY:i.y,targetZ:i.z,positionX:o.x,positionY:o.y,positionZ:o.z},1e3).easing(TWEEN.Easing.Sinusoidal.InOut).onUpdate((function(){e.controls.target.set(this.targetX,this.targetY,this.targetZ),e.camera.position.set(this.positionX,this.positionY,this.positionZ)})).onComplete((function(){})).start()},createSpriteText(e,t){const n=this.createTextCanvas(e,t),{_size:o}=n,{width:r,height:i}=o,a=new THREE.SpriteMaterial({map:n,color:16777215,sizeAttenuation:!0,transparent:!0}),s=new THREE.Sprite(a);return s.scale.set(r/64,i/64,1),s.center.set(.5,0),s.renderOrder=100,s},createSunLight(e){e=e||{};const{color:t="#ffffff",intensity:n=.5,width:o=1024,height:r=512,near:i=.1,far:a=600,left:s=-40,right:l=40,top:c=20,bottom:u=-20}=e,h=new THREE.DirectionalLight(t,n);return h.castShadow=!0,h.add(this.createLensflare()),h.shadow.mapSize.width=o,h.shadow.mapSize.height=r,h.shadow.camera.near=i,h.shadow.camera.far=a,h.shadow.camera.left=s,h.shadow.camera.right=l,h.shadow.camera.top=c,h.shadow.camera.bottom=u,h},calBuildData(e){const t=[];let n=-1/0,o=1/0,r=-1/0,i=1/0;const a=e.data;for(let e=0,s=a.length;e<s;e++){const s=a[e].geometry,l=[];t.push(l);for(let e=0,t=s.length;e<t;e++){const t=s[e][0],a=s[e][1];l.push(new THREE.Vector3(t,0,a)),n<=t&&(n=t),o>=t&&(o=t),r<=a&&(r=a),i>=a&&(i=a)}}const s=this.getChangeMatrix({minX:o,minZ:i,maxX:n,maxZ:r});for(let e=0,n=t.length;e<n;e++){const n=[];for(let o=0,r=t[e].length;o<r;o++){const r=t[e][o];r.applyMatrix4(s),n.push([r.x,r.z])}a[e].geometry=n}},handleBuild(e){const t=GeometryExtrude.flatten(e);return t.indices=GeometryExtrude.triangulate(t.vertices,t.holes),t.beveling=GeometryExtrude.offsetPolygon2(t.vertices,t.holes,!0),t},createBuildGeo(e){e=e||{};const{indices:t,positions:n,uvs:o,normals:r,colors:i}=e,a=this.geo.buf();return a.setIndex(t),a.addAttribute("position",new THREE.Float32BufferAttribute(n,3)),o&&a.addAttribute("uv",new THREE.Float32BufferAttribute(o,2)),r?a.addAttribute("normal",new THREE.Float32BufferAttribute(r,2)):a.computeVertexNormals(),i&&a.addAttribute("color",new THREE.Float32BufferAttribute(i,3)),a.computeBoundingBox(),a.computeBoundingSphere(),a},createTopMesh(e,t){const{texture:n,buildIndex:o}=t,r=[],i=[],a=[],s=[],l=[],c=[],u=e.indices,h=e.vertices,d=e.beveling,p=.5*h.length;let m=-1/0,g=1/0,f=-1/0,E=1/0;for(let e=0;e<p;e++){const t=h[2*e],n=h[2*e+1],o=0*d[2*e],l=0*d[2*e+1];r.push(t-o,-0,n-l),m<t-o&&(m=t-o),g>t-o&&(g=t-o),f<n-l&&(f=n-l),E>n-l&&(E=n-l),i.push(t,0,n),i.push(t-o,0,n-l),i.push(t-o,-0,n-l);let c,u,T,b,w=p+3*e,x=p+3*e+1;e<p-1?(c=p+3*e+3,u=p+3*e+4,T=p+3*e+2,b=p+3*e+5):(c=p,u=p+1,T=x+1,b=p+2),a.push(w,c,u,u,x,w),s.push(x,u,b,b,T,x)}for(let e=0;e<p;e++)l.push((r[3*e]-g)/(m-g),(r[3*e+2]-E)/(f-E)),c.push(0,1,0,.5,0,0);const T=this.createBuildGeo({indices:u.concat(a,s),positions:r.concat(i),uvs:l.concat(c)}),b=new THREE.Mesh(T,this.mtl.lambert({map:n,transparent:!0,opacity:1,color:16777215,side:THREE.BackSide,skinning:!0,wireframe:!1}));return b.castShadow=!0,b.receiveShadow=!0,b.userData={_buildIndex:o,_isTop:!0},b},highlightObject(e){e&&i.isArray(e)&&e.forEach(e=>{if(!e.userData._isTop){const{highlightColors:t}=e.userData;e.material.color=t[0],e.material.opacity=t[1]}})},cancelHighlight(e){if(e&&i.isArray(e)){const t=this.getColorArr("#FFFFFF");e.forEach(e=>{e.userData._isTop||(e.material.color=t[0],e.material.opacity=t[1])})}},createSideMesh(e,t){const{texture:n=null,buildIndex:o,floorIndex:r=0,color:i="#FFFFFF",floorHeight:a,floorCount:s,highlightColor:l}=t,c=[],u=[],h=[],d=[],p=e.vertices,m=.5*p.length;let g=0;const f=[],[E,T]=this.getColorArr(i);for(let e=0;e<m;e++){const t=p[2*e],n=p[2*e+1];if(c.push(t,r*a,n),c.push(t,(r+1)*a,n),c.push(t,r*a,n),c.push(t,(r+1)*a,n),d.push(E.r,E.g,E.b,E.r,E.g,E.b,E.r,E.g,E.b,E.r,E.g,E.b),e<m-1?u.push(4*e,4*e+1,4*e+3,4*e,4*e+3,4*e+2,4*e+2,4*e+3,4*e+5,4*e+2,4*e+5,4*e+4):u.push(4*e,4*e+1,4*e+3,4*e,4*e+3,4*e+2,4*e+2,4*e+3,1,4*e+2,1,0),e>0){const o=new THREE.Vector3(p[2*(e-1)],0,p[2*(e-1)+1]),r=new THREE.Vector3(t,0,n),i=o.sub(r).length();g+=i,f.push(i)}}h.push(0,0,0,1,1,0,1,1);for(let e=0,t=f.length;e<t;e++)h.push(f[e]/g,0,f[e]/g,1,1,0,1,1);const b=this.createBuildGeo({indices:u,positions:c,uvs:h,colors:d}),w=new THREE.Mesh(b,this.mtl.lambert({map:n,transparent:!0,opacity:1,color:"#ffffff",vertexColors:THREE.VertexColors,side:THREE.FrontSide,wireframe:!1})),x=this.getColorArr(l);return w.userData={_color:E,_opacity:T,highlightColors:x,_buildIndex:o+1,_floorIndex:r+1,sunFace:{},_sunTimeCal:!1,_sunTimeShow:!1,bdResult:e,floorCount:s},w.castShadow=!0,w.receiveShadow=!0,w},createTexture(e){const{url:t,xRepeat:n=8,yRepeat:o=8}=e,r=this.textureLoader.load(t);return r.wrapS=THREE.RepeatWrapping,r.wrapT=THREE.RepeatWrapping,r.repeat.set(n,o),r},createBuildings(e,t,n){const o=new THREE.Object3D;o.scale.y=.001;const{topUrl:r="",sideUrl:i="",fontColor:a="#FF0000",strokeWidth:s=2,strokeColor:l="#ffffff",oddColor:c="#CCCED1",evenColor:u="#6E6660",fontSize:h=20,highlightColor:d="#FFFF00",speed:g=.01,maxWidth:f,maxHeight:E}=n;p.width=f||p.width,p.height=E||p.height,o._speed=g,m=n.floorHeight||.5;let T=0,b=e.data.length;this.calBuildData(e);const w=this.createTexture({url:r}),x=this.createTexture({url:i});for(;T<b;T++){const n=e.data[T],{floor:r,name:i}=n,p=this.handleBuild([n.geometry]),g=this.createTopMesh(p,{texture:w,buildIndex:T+1});t.push(g),g.position.y=m*r,o.add(g);const f=this.createSpriteText(i||`${T+1}#${r}层`,{fontSize:h,fontColor:a,strokeColor:l,strokeWidth:s});f.position.copy(g.geometry.boundingSphere.center.clone().add(g.position)),o.add(f);for(let e=0;e<r;e++){const n=this.createSideMesh(p,{color:e%2==0?u:c,texture:x,buildIndex:T,floorIndex:e,floorHeight:m,floorCount:r,highlightColor:d});t.push(n),o.add(n)}}return o},calFaceCenter(e){const{leftTop:t,leftBottom:n,rightTop:o,rightBottom:r}=e;return t.add(n).multiplyScalar(.5).add(o.add(r).multiplyScalar(.5)).multiplyScalar(.5)},calSunTime(e,t){console.time("计算时间"),e.forEach(n=>{n.userData._sunTimeShow&&this.calSingleFloorSunTime(n,e,t)}),console.timeEnd("计算时间")},calSingleFloorSunTime(e,t,n){const{startIndex:o,endIndex:r,points:i,originPoint:a}=n._sunPath.userData;e.userData.sunFace={},e.userData._sunTimeCal=!0;let s=E.findIntersectArr(e,t);for(let t=o;t<r;t+=16){const o=new THREE.Vector3(i[3*t],i[3*t+1],i[3*t+2]),{array:r}=e.geometry.attributes.position;for(let t=6,i=r.length;t<i;t+=12){let l,c,u,h;l=new THREE.Vector3(r[t],r[t+1],r[t+2]),c=new THREE.Vector3(r[t+3],r[t+4],r[t+5]),t<i-12?(u=new THREE.Vector3(r[t+6],r[t+7],r[t+8]),h=new THREE.Vector3(r[t+9],r[t+10],r[t+11])):(u=new THREE.Vector3(r[0],r[1],r[2]),h=new THREE.Vector3(r[3],r[4],r[5]));const d=this.calFaceCenter({leftBottom:l,leftTop:c,rightBottom:u,rightTop:h}).add(new THREE.Vector3(0,.25*m,0)),p=a.clone().sub(o.clone()).normalize(),g=d.clone().sub(p.clone().multiplyScalar(100)),f=this.getFaceNormal([c,h,u]);if(p.dot(f)>0)continue;n.raycaster.set(g,p);const E=n.raycaster.intersectObjects(s,!1);if(E.length>0&&E[0].object===e){const{faceIndex:n}=E[0];n!==t/3&&n!==t/3+1||(void 0!==e.userData.sunFace[n]?e.userData.sunFace[n]+=40:e.userData.sunFace[n]=40)}}}s.forEach(e=>{-1===t.indexOf(e)&&E.disposeObj(e)}),s=[]},findIntersectArr(e,t){const n=[],{_buildIndex:o}=e.userData,r={};return t.forEach(e=>{const t=e.userData._buildIndex;t!==o?(r[t]||e.userData._isTop||(n.push(E.createVirtualBuilding(e.userData)),r[t]=!0),e.userData._isTop&&n.push(e)):t===o&&n.push(e)}),n},createVirtualBuilding(e){const{bdResult:t,floorCount:n}=e;return E.createSideMesh(t,{floorHeight:m*n})},setSunLightColor(e){const{array:t}=e.geometry.attributes.color,{sunFace:n}=e.userData;for(let e=6,o=t.length;e<o;e+=12){const r=this.getColorArr(i.getSunLightColorWithLength(n[e/3]))[0];if(e<o-12)for(let n=0;n<12;n+=3)t[e+n]=r.r,t[e+n+1]=r.g,t[e+n+2]=r.b;else for(let n=0;n<6;n+=3)t[e+n]=r.r,t[e+n+1]=r.g,t[e+n+2]=r.b,t[n]=r.r,t[n+1]=r.g,t[n+2]=r.b}e.geometry.attributes.color.needsUpdate=!0,e.userData._sunTimeShow=!0},cancelSunLightColor(e){const{_color:t}=e.userData,{array:n}=e.geometry.attributes.color;for(let e=0,o=n.length;e<o;e+=3)n[e]=t.r,n[e+1]=t.g,n[e+2]=t.b;e.geometry.attributes.color.needsUpdate=!0,e.userData._sunTimeShow=!1},sunTimeRefresh(e){e.forEach(e=>{e.userData._sunTimeShow&&this.setSunLightColor(e)})},createSkybox(e){const{path:t}=e,n=[t+"px.jpg",t+"nx.jpg",t+"py.jpg",t+"ny.jpg",t+"pz.jpg",t+"nz.jpg"],o=E.cubeLoader.load(n);return o.format=THREE.RGBFormat,o},createGround(e){const t=this,n=new THREE.Object3D,{imageUrl:o,width:r=50,height:i=50,xRepeat:a=20,yRepeat:s=20,radius:l=40,radiusSegment:c=64,mapUrl:u,mapColor:h}=e;if(o){const e=this.geo.circle(l,c),r=t.textureLoader.load(o);r.wrapT=THREE.RepeatWrapping,r.wrapS=THREE.RepeatWrapping,r.anisotropy=16,r.repeat.set(a,s);const i=t.mtl.lambert({map:r,transparent:!1,side:THREE.DoubleSide}),u=new THREE.Mesh(e,i);u.rotation.x=Math.PI/2,u.receiveShadow=!0,n.add(u)}if(u){const e=this.geo.plane(r,i),o=t.textureLoader.load(u);o.wrapT=THREE.RepeatWrapping,o.wrapS=THREE.RepeatWrapping,o.anisotropy=16,o.repeat.set(a,s);const l=this.getColorArr(h),c=t.mtl.lambert({map:o,transparent:!0,depthWrite:!1,color:l[0],opacity:l[1],side:THREE.DoubleSide}),d=new THREE.Mesh(e,c);d.rotation.x=Math.PI/2,d.receiveShadow=!0,d.position.y+=.001,n.add(d)}return n},createAxis(e){e=e||{};const{length:t=100,divsion:n=100}=e,o=new THREE.Object3D,r=new THREE.AxesHelper(t);o.add(r);const i=new THREE.GridHelper(t,n);return i.material.opacity=.25,i.material.transparent=!0,i.position.set(t/2,.1,t/2),o},createLensflare(){const e=this.textureLoader.load("./images/lensflare0.png"),t=this.textureLoader.load("./images/lensflare3.png"),n=new THREE.Lensflare;return n.addElement(new THREE.LensflareElement(e,256,0)),n.addElement(new THREE.LensflareElement(t,80,.5)),n.addElement(new THREE.LensflareElement(t,60,.6)),n.addElement(new THREE.LensflareElement(t,70,.7)),n.addElement(new THREE.LensflareElement(t,120,.9)),n.addElement(new THREE.LensflareElement(t,70,1)),n},getFaceNormal(e){const t=e[0].clone(),n=e[1].clone();return e[2].clone().sub(t).normalize().cross(n.sub(t).normalize()).normalize().multiplyScalar(-1)},getNormals(e,t){const n=[];for(let t=0,o=e.length;t<o;t+=3)n.push(new THREE.Vector3(e[t],e[t+1],e[t+2]));const o=[];for(let e=0,r=t.length;e<r;e+=3){const r=n[t[e]].clone(),i=n[t[e+1]].clone(),a=n[t[e+2]].clone(),s={};o.push(s),s.points=[],s.points.push(t[e],t[e+1],t[e+2]),s.normal=a.sub(r).normalize().cross(i.sub(r).normalize()).normalize()}const r=[];for(let t=0,n=e.length/3;t<n;t++){let e=new THREE.Vector3;o.forEach(n=>{-1!==n.points.indexOf(t)&&e.add(n.normal)}),e.normalize(),r.push(e.x,e.y,e.z)}return r},createTextCanvas(e,t){t=t||{};const{fontSize:n=12,fontColor:o="#FFFFFF",strokeColor:r="#FFFFFF",strokeWidth:i=2}=t;let a=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");const s=a.getContext("2d");s.font="500 "+n+"px Arial";const l=s.measureText(e),c=THREE.Math.ceilPowerOfTwo(l.width),u=THREE.Math.ceilPowerOfTwo(n);a.width=c,a.height=u,a.style.backgroundColor="rgba(255,255,255,0.0)",s.font="500 "+n+"px Arial",s.textAlign="center",s.textBaseline="middle",s.lineWidth=i,s.strokeStyle=r,s.strokeText(e,c/2,u/2),s.fillStyle=o,s.fillText(e,c/2,u/2);const h=new THREE.Texture(a);return h.needsUpdate=!0,h._size={width:c,height:u,realWidth:l.width},a=null,h},createPlaneTexture(e){e=e||{};const{content:t="",color:n="#FFFFFF",fontSize:o}=e,r=this.createTextCanvas(t,{fontSize:o}),{_size:i}=r,{width:a,height:s}=i,l=this.getColorArr(n),c=this.geo.plane(a/30,s/30),u=this.mtl.lambert({map:r,transparent:!0,side:THREE.DoubleSide,depthWrite:!1,color:l[0],opacity:l[1],blending:THREE.NormalBlending}),h=new THREE.Mesh(c,u);return h._size={width:a/30,height:s/30},h.renderOrder=10,h.receiveShadow=!0,h},createSingleTextIcon(e){e=e||{};const{content:t,fontSize:n,fontColor:o}=e,r=new THREE.Object3D,i=this.createPlaneTexture({content:t,fontSize:n});i.position.y-=i._size.height/2;const a=this.geo.circle(2,3),s=this.getColorArr(o),l=this.mtl.lambert({transparent:!0,opacity:s[1],side:THREE.DoubleSide,color:s[0]}),c=new THREE.Mesh(a,l);return c.receiveShadow=!0,c.rotation.z-=Math.PI/6,c.position.y+=2,r.add(i),r.add(c),r},createWheelText(e){e=e||{};const{fontSize:t,outerRadius:n,fontColor:o}=e,r=new THREE.Object3D,i=this.createSingleTextIcon({content:"东",fontSize:t,fontColor:o});i.position.set(n,.01,0),i.rotation.x-=Math.PI/2,i.rotation.z-=Math.PI/2,r.add(i);const a=this.createSingleTextIcon({content:"西",fontSize:t,fontColor:o});a.position.set(-n,.01,0),a.rotation.x+=Math.PI/2,a.rotation.z+=Math.PI/2,r.add(a);const s=this.createSingleTextIcon({content:"南",fontSize:t,fontColor:o});s.position.set(0,.01,n),s.lookAt(new THREE.Vector3),s.rotation.x+=Math.PI/2,r.add(s);const l=this.createSingleTextIcon({content:"北",fontSize:t,fontColor:o});return l.position.set(0,.01,-n),l.lookAt(new THREE.Vector3),l.rotation.x-=Math.PI/2,r.add(l),r},createWheelLine(e){e=e||{};const{innerRadius:t,outerRadius:n,lineColor:o}=e,r=this.geo.buf(),a=this.getColorArr(o),s=this.mtl.line({transparent:!0,color:a[0],opacity:a[1]}),l=[],c=d/4,u=2*Math.PI/d;for(let e=0;e<d;e++){l.push(t*Math.cos(e*u),.01,t*Math.sin(e*u));let n=t;i.equals(e%c)?n+=1.5:n+=1,l.push(n*Math.cos(e*u),.01,n*Math.sin(e*u))}const h=this.createCurvePoints({xRadius:n,yRadius:n,aRotation:0});for(let e=1,t=h.length;e<t;e++)l.push(h[e-1].x,.01,h[e-1].y),l.push(h[e].x,.01,h[e].y);r.addAttribute("position",new THREE.Float32BufferAttribute(l,3));const p=new THREE.LineSegments(r,s);return p.receiveShadow=!0,p},createBearingWheel(e){e=e||{};const{width:t=20,height:n=20,fontSize:o=80,fontColor:r="#ffffff",lineColor:i="#ffffff"}=e,a=new THREE.Object3D,s=Math.max(t,n)*Math.sqrt(2)/2,l=this.createWheelLine({innerRadius:s,outerRadius:s+5,lineColor:i});a.add(l);const c=this.createWheelText({outerRadius:s+5,fontSize:o,fontColor:r});return a.add(c),a},create3DMesh(){const e=this.geo.box(5,10,5);e.applyMatrix((new THREE.Matrix4).makeTranslation(0,5,0));const t=this.mtl.lambert({color:16777215}),n=new THREE.Mesh(e,t);return n.castShadow=!0,n.receiveShadow=!0,n},createCurvePoints(e){e=e||{};const{xRadius:t,yRadius:n,aRotation:o=-Math.PI/2,pointCount:r=d-1}=e;return new THREE.EllipseCurve(0,0,t,n,0,2*Math.PI,!1,o).getPoints(r)},createSunPath(e){const{lng:t,lat:n,date:o}=e,r=h.getNoonSunAngle({lat:n,date:o});let{riseTime:i,dropTime:a}=h.getSunRiseDropMsg({lng:t,lat:n,date:o});const s=a-i,l=Math.floor(60*i/2.5),c=Math.floor(60*a/2.5),u=n*Math.PI/h.PI_ANGLE,d=2*Math.PI*(h.TIME_ZONE-t)/360,p=r+u,m=400*Math.sin(p),g=new THREE.Vector3(0,-400*Math.cos(p)*Math.sin(u),400*Math.cos(p)*Math.cos(u)),f=this.createCurvePoints({xRadius:m,yRadius:m}),E=(new THREE.BufferGeometry).setFromPoints(f);let T=(new THREE.Matrix4).makeTranslation(0,g.y,g.z);T=T.multiply((new THREE.Matrix4).makeRotationZ(-d)),T=T.multiply((new THREE.Matrix4).makeRotationX(u)),E.applyMatrix(T);const b=new THREE.LineBasicMaterial({color:16711680});i=h.getTimeStr(24*l/576),a=h.getTimeStr(24*c/576);const w=new THREE.Line(E,b);return w.userData={startIndex:l,endIndex:c,riseTime:i,dropTime:a,sunTimeLength:s,date:o,originPoint:new THREE.Vector3(0,g.y,g.z),points:E.attributes.position.array},w},getColorArr(e){function t(e){return 1===e.length?"0"+e:""+e}if(i.isArray(e))return e;const n=[],o=(""+e).toLowerCase().replace(/\s/g,"");if(/^((?:rgba)?)\(\s*([^)]*)/.test(o)){const e=o.replace(/rgba\(|\)/gi,"").split(","),r=[t(Math.round(e[0]-0||0).toString(16)),t(Math.round(e[1]-0||0).toString(16)),t(Math.round(e[2]-0||0).toString(16))];n[0]=this.color("#"+r.join("")),n[1]=Math.max(0,Math.min(1,e[3]-0||0))}else"transparent"===e?(n[0]=this.color(),n[1]=0):(n[0]=this.color(e),n[1]=1);return n},disposeObj(e){e instanceof THREE.Object3D&&this.objectTraverse(e,E.disposeNode.bind(E))},disposeNode(e){if(i.isArray(e._txueArr)){for(let t=0;t<e._txueArr.length;t++)e._txueArr[t].dispose(),e._txueArr[t]=null;e._txueArr=null}this.deleteGeometry(e),this.deleteMaterial(e),e.dispose&&e.dispose(),e.parent&&e.parent.remove(e),e.userData=null,e=null},deleteGeometry(e){e.geometry&&e.geometry.dispose&&(e.geometry._bufferGeometry&&e.geometry._bufferGeometry.dispose(),e.geometry.dispose(),e.geometry=null)},deleteMaterial(e){i.isArray(e.material)?e.material.forEach(E.disposeMaterial.bind(E)):e.material&&this.disposeMaterial(e.material),e.material=null},disposeMaterial(e){Object.keys(e).forEach(t=>{e[t]&&i.isFunction(e[t].dispose)||"uniforms"===t?"uniforms"===t?Object.keys(e.uniforms).forEach(t=>{let n=e.__webglShader?e.__webglShader.uniforms[t]:void 0;n&&n.value&&(n.value.dispose&&n.value.dispose(),n.value=null),n=e.uniforms[t],n.value&&(n.value.dispose&&n.value.dispose(),n.value=null)}):(e[t].dispose(),e[t]=null):"program"!==t&&"fragmentShader"!==t&&"vertexShader"!==t||(e[t]=null)}),e.dispose(),e=null},objectTraverse(e,t){if(!i.isFunction(t))return;const{children:n}=e;for(let e=n.length-1;e>=0;e--)E.objectTraverse(n[e],t);t(e)}};var T=E;let b=null,w=!1,x=0,y={x:-1,y:-1};const _={eventArr:[],highlightObjects:[],getFloorArr(e){const t=[];return this.eventArr.forEach(n=>{n.userData._buildIndex===e&&t.push(n)}),t},getEventClient(e){let t,n;return"touchend"===e.type||"touchstart"===e.type?(t=e.changedTouches[0].clientX,n=e.changedTouches[0].clientY):(t=e.offsetX,n=e.offsetY),{x:t,y:n}},getPickObjects(e,t){const{x:n,y:o}=this.getEventClient(t);return e.mouseVector.x=n/e.container.offsetWidth*2-1,e.mouseVector.y=-o/e.container.offsetHeight*2+1,e.raycaster.setFromCamera(e.mouseVector,e.camera),e.raycaster.intersectObjects(this.eventArr,!0)},doubleClick(e,t){const n=_.getPickObjects(e,t);if(n.length>0){const t=n[0].object,{userData:o}=t,{_sunTimeShow:r,_sunTimeCal:i}=o;r?T.cancelSunLightColor(t):(i||T.calSingleFloorSunTime(t,_.eventArr,e),T.setSunLightColor(t)),e._doubleClickEvent&&e._doubleClickEvent({_floorIndex:o._floorIndex,_buildIndex:o._buildIndex,floorCount:_.getFloorArr(o._buildIndex).length})}else e._doubleClickEvent&&e._doubleClickEvent()},onDocumentMouseDown(e){e.preventDefault(),y=_.getEventClient(e)},onDocumentMouseUp(e){e.preventDefault();const t=this;if(x++,clearTimeout(w),w=setTimeout((function(){const n=_.getEventClient(e);if(i.equals(n.x,y.x)&&i.equals(n.y,y.y)){const n=_.getPickObjects(t,e);if(n.length>0){const{object:e}=n[0],{userData:o}=e;T.cameraToObject(t,e),T.cancelHighlight(_.highlightObjects),_.highlightObjects=_.getFloorArr(o._buildIndex),T.highlightObject(_.highlightObjects),t._mouseDownFunction&&t._mouseDownFunction({floorCount:_.highlightObjects.length,_floorIndex:o._floorIndex,_buildIndex:o._buildIndex})}else t._mouseDownFunction&&t._mouseDownFunction(),T.cancelHighlight(_.highlightObjects)}y={x:-1,y:-1},x=0}),300),x>1){x=0,clearTimeout(w);const n=_.getEventClient(e);i.equals(n.x,y.x)&&i.equals(n.y,y.y)&&_.doubleClick(t,e)}},onDocumentDoubleClick(e){e.preventDefault(),clearTimeout(w),_.doubleClick(this,e)},onDocumentMouseMove(e){e.preventDefault();const t=this;x=0;const n=_.getPickObjects(t,e);n.length>0?n[0].object!==b&&(b=n[0].object,t._mouseMoveFunction&&t._mouseMoveFunction(_.getFloorArr(b.userData._buildIndex))):(b=null,t._mouseMoveFunction&&t._mouseMoveFunction())},initEvent(e){window.addEventListener("resize",e.onWindowResize.bind(e),!1),e.container.addEventListener("mousemove",_.onDocumentMouseMove.bind(e),!1),e.container.addEventListener("touchmove",_.onDocumentMouseMove.bind(e),!1),e.container.addEventListener("mousedown",_.onDocumentMouseDown.bind(e),!1),e.container.addEventListener("touchstart",_.onDocumentMouseDown.bind(e),!1),e.container.addEventListener("touchend",_.onDocumentMouseUp.bind(e),!1),e.container.addEventListener("mouseup",_.onDocumentMouseUp.bind(e),!1)},removeEvent(e){window.removeEventListener("resize",e.onWindowResize.bind(e),!1),e.container.removeEventListener("mousemove",_.onDocumentMouseMove.bind(e),!1),e.container.removeEventListener("touchmove",_.onDocumentMouseMove.bind(e),!1),e.container.removeEventListener("mousedown",_.onDocumentMouseDown.bind(e),!1),e.container.removeEventListener("touchstart",_.onDocumentMouseDown.bind(e),!1),e.container.removeEventListener("touchend",_.onDocumentMouseUp.bind(e),!1),e.container.removeEventListener("mouseup",_.onDocumentMouseUp.bind(e),!1)}};var R=_;const S=function(e){return!!(e instanceof HTMLElement)||!(!e||"object"!=typeof e||1!==e.nodeType||"string"!=typeof e.nodeName)},v=e=>({w:e.offsetWidth,h:e.offsetHeight}),M={background:{color:"#ffffff",opacity:0},camera:{fov:45,near:1,far:2e4,position:[0,0,100]},controls:{enablePan:!0,panSpeed:1,enableZoom:!0,zoomSpeed:1,enableRotate:!0,rotateSpeed:1,enableDamping:!1,dampingFactor:.05,distance:[10,1e3],polarAngle:[0,Math.PI/2],azimuthAngle:[-1/0,1/0],target:[0,0,0]},render:{pixelRatio:1,light:{color:"#FFFFFF",intensity:.5}},localPosition:{lng:104.07,lat:30.67}};let H={},C=null,D=!0,F=!1;t.default=class{constructor(e,t){const n=(e=>{let t=null;return t="object"==typeof e?S(e)?e:S(e[0])?e[0]:null:document.getElementById(e),t})(e);if((()=>{try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){return!1}})()&&null!=n)try{t=t||{},H=i.extend(!0,{},M,t),this.container=(e=>{const t=document.createElement("div");return t.id=e,t.style="width:100%;height:100%;overflow:hidden;position:relative !important;",t})(THREE.Math.generateUUID()),this.parentCont=n,this.parentCont.append(this.container),this.scene=new THREE.Scene,this._directLight=T.createSunLight(H.render.light),this._directLight.position.set(100,500,2),this.scene.add(this._directLight);const e=new THREE.AmbientLight("#756e63");this.scene.add(e),this.clock=new THREE.Clock;const a=v(this.container),s=H.camera,l=H.background,c=H.controls;this.camera=new THREE.PerspectiveCamera(s.fov,a.w/a.h,s.near,s.far),this.camera.position.set(s.position[0],s.position[1],s.position[2]),this.controls=new THREE.OrbitControls(this.camera,this.container),this.controls.target.set(c.target[0],c.target[1],c.target[2]),o=this.controls,r=c,o.zoomSpeed=r.zoomSpeed,o.enablePan=r.enablePan,o.enableKeys=r.enablePan,o.panSpeed=r.panSpeed,o.keyPanSpeed=r.panSpeed,o.enableZoom=r.enableZoom,o.rotateSpeed=r.rotateSpeed,o.enableRotate=r.enableRotate,o.enableDamping=r.enableDamping,o.dampingFactor=r.dampingFactor,o.minDistance=r.distance[0],o.maxDistance=r.distance[1],o.minPolarAngle=r.polarAngle[0],o.maxPolarAngle=r.polarAngle[1],o.minAzimuthAngle=r.azimuthAngle[0],o.maxAzimuthAngle=r.azimuthAngle[1],this.raycaster=new THREE.Raycaster,this.mouseVector=new THREE.Vector2,this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.autoClear=!1,this.renderer.setSize(a.w,a.h),this.renderer.setPixelRatio(H.render.pixelRatio),this.renderer.setClearColor(l.color,l.opacity),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,this.container.appendChild(this.renderer.domElement),R.initEvent(this)}catch(e){console.log(e)}var o,r}render(){const e=this,t=function(){e.renderer.render(e.scene,e.camera),requestAnimationFrame(t),e.controls&&e.controls.update(),((e,t)=>{if(t<.1){if(e._sunPath&&F){const{startIndex:n,endIndex:o,points:r,date:i}=e._sunPath.userData;if(e._directLight&&D){const a=Math.floor(e._directLight._index);if(e._directLight.position.set(r[3*a],r[3*a+1],r[3*a+2]),e._directLight._index>o&&(e._directLight._index=n),C){const e=24*a/576,t=h.getTimeStr(e),n=e-8,o=i.getTime()+3600*n;C({currentTime:t,milliSeconds:o})}e._directLight._index+=10*t}}if(e._spread){const{_perTime:n,_transTime:o}=e._spread.userData;e._spread.material.uniforms.u_time.value=o/n,e._spread.userData._transTime+=t,e._spread.userData._transTime>=n&&(e._spread.userData._transTime=0)}if(e._cameraAngleCallback){const t=e.controls.target.clone(),n=e.camera.position.clone(),o=t.sub(n).setY(0).normalize();let r=o.angleTo(new THREE.Vector3(0,0,-1));r=o.x>=0?r:2*Math.PI-r,e._cameraAngleCallback(r)}e._builds&&(e._builds.scale.y<1&&(e._builds.scale.y+=e._builds._speed),e._builds.scale.y>=1&&(F=!0))}})(e,e.clock.getDelta()),e.stats&&e.stats.update(),TWEEN.update()};t()}createGround(e){const t=this;t._ground&&T.disposeObj(t._ground),t._ground=T.createGround(e),t.scene.add(t._ground)}createBear(e){this.scene.add(T.createBearingWheel(e))}createSkybox(e){const{fog:t}=e,{show:n=!0,color:o="#FFFFFF",density:r=.0025}=t;this.scene.background=T.createSkybox(e),n&&(this.scene.fog=new THREE.FogExp2(o,r))}createSpread(e){const t=this;t._spread&&T.disposeObj(t._spread),t._spread=T.createSpreadObject(e),t.scene.add(t._spread)}setSunLengthColors(e){i.sunLengthColors=e.concat(),T.sunTimeRefresh(R.eventArr)}setPixelRatio(e){this.renderer.setPixelRatio(e)}setSunAnimateFunction(e){C=e}createBuildings(e,t,n){const o=this;o._builds&&(R.eventArr=[],R.highlightObjects=[],T.disposeObj(o._builds)),o._calSunTimeProgress=n,e.constructor===Object?(o._builds=T.createBuildings(e,R.eventArr,t),o.scene.add(o._builds),T.calSunTime(R.eventArr,o)):i.ajaxQuer(e,(function(e){console.time("建筑构建时间"),o._builds=T.createBuildings(e,R.eventArr,t),o.scene.add(o._builds),T.calSunTime(R.eventArr,o),console.timeEnd("建筑构建时间")}))}setSunPath(e,t){const n=this,o=H.localPosition;if(n._sunPath&&T.disposeObj(n._sunPath),n._sunPath=T.createSunPath({lng:o.lng,lat:o.lat,date:e}),n.scene.add(n._sunPath),n._builds&&(T.calSunTime(R.eventArr,n),T.sunTimeRefresh(R.eventArr)),n._directLight){const{points:e}=n._sunPath.userData,t=n._sunPath.userData.startIndex;n._directLight._index=t,n._directLight.position.set(e[3*t],e[3*t+1],e[3*t+2])}t&&t({riseTime:n._sunPath.userData.riseTime,dropTime:n._sunPath.userData.dropTime})}onWindowResize(){const e=v(this.container);this.camera.aspect=e.w/e.h,this.camera.updateProjectionMatrix(),this.renderer.setSize(e.w,e.h)}setMouseMoveFunction(e){this._mouseMoveFunction=e}setMouseDownFunction(e){this._mouseDownFunction=e}setDoubleClickEvent(e){this._doubleClickEvent=e}setSunPositionAnimate(e){D=e}setSunPositionCurrentTime(e){const t=this;if(D=!1,t._sunPath){const{points:n}=t._sunPath.userData;if(t._directLight){const o=e.split(":");if(2!==o.length)return;const r=parseFloat(o[0]),i=parseFloat(o[1])+60*r,a=Math.floor(i/2.5);t._directLight.position.set(n[3*a],n[3*a+1],n[3*a+2]),t._directLight._index=a}}}setSunShineOfFloor(e,t){const n=this;for(let o=0,r=R.eventArr.length;o<r;o++){const r=R.eventArr[o];if(r.userData._buildIndex===e){if(void 0!==t&&r.userData._floorIndex===t){r.userData._sunTimeCal||T.calSingleFloorSunTime(r,R.eventArr,n),T.setSunLightColor(r);break}void 0===t&&(r.userData._sunTimeCal||T.calSingleFloorSunTime(r,R.eventArr,n),T.setSunLightColor(r))}}}cancelSunShineOfFloor(e,t){for(let n=0,o=R.eventArr.length;n<o;n++){const o=R.eventArr[n];if(o.userData._buildIndex===e){if(void 0!==t&&o.userData._floorIndex===t){T.cancelSunLightColor(o);break}void 0===t&&T.cancelSunLightColor(o)}}}resetCamera(){const e=this,{camera:t,controls:n}=H,{position:o}=t,{target:r}=n;T.cameraToPosition(e,new THREE.Vector3(o[0],o[1],o[2]),new THREE.Vector3(r[0],r[1],r[2])),e._cameraAngleCallback&&e._cameraAngleCallback(0)}setCameraAngleCallback(e){this._cameraAngleCallback=e}disposeRender(){R.removeEvent(this),this.controls.dispose(),this.container.remove(),this.renderer.forceContextLoss(),this.renderer.domElement=null,this.renderer.context=null,this.renderer=null}}}]).default}));